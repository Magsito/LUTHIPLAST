<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nueva Cotizaci√≥n</title>

  <!-- jsPDF + AutoTable (para PDF) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <!-- Agregar Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.6/dist/umd/supabase.js"></script>

  <style>
    :root{
      --bg: #0c1434; /* Fondo oscuro */
      --card: #ffffff; /* Fondo blanco para las tarjetas */
      --ink: #0c1434; /* Texto claro */
      --primary: #7e8a97; /* Color primario de texto */
      --primary-ink: #fff; /* Texto en color blanco */
      --line: #e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1000px; margin:28px auto; padding:0 16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.05)}
    header{display:flex; align-items:center; gap:12px; padding:20px 22px; border-bottom:1px solid var(--line)}
    header h1{margin:0; font-size:24px; color: var(--primary)}
    .form{display:grid; grid-template-columns:1fr 1fr; gap:14px 18px; padding:18px 22px}
    .field{display:flex; gap:10px; align-items:center}
    .field label{width:110px; color:var(--muted); font-size:14px}
    .field input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:15px}
    .toolbar{display:flex; justify-content:flex-end; gap:10px; padding:0 22px 16px}
    .btn{border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600}
    .btn.primary{background:var(--primary); color:var(--primary-ink); border:none}
    .btn.icon{display:inline-flex; align-items:center; gap:8px}
    .btn:active{transform:translateY(1px)}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{background:#f3f4f6; text-align:left; padding:12px; border-bottom:1px solid var(--line); color:#111827}
    tbody td{padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:middle}
    tbody td.num{text-align:right; white-space:nowrap}
    tbody td.actions{width:40px; text-align:center}
    tfoot td{padding:8px 12px}
    tfoot tr.subtotal td,
    tfoot tr.igv td,
    tfoot tr.total td{border-top:1px solid var(--line)}
    tfoot tr.total td{font-weight:800; font-size:16px}
    input.cell{width:100%; border:1px solid var(--line); border-radius:6px; padding:8px 10px; font-size:14px}
    input.cell.center{text-align:center}
    input.cell.right{text-align:right}
    .aside{padding:16px 22px 22px; border-top:1px solid var(--line)}
    .log{margin-top:24px}
    .log h3{margin:0 0 10px 0; font-size:18px}
    .log ul{list-style:none; padding:0; margin:0; display:grid; gap:8px}
    .log li{display:flex; align-items:center; justify-content:space-between; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px 12px}
    .log small{color:var(--muted)}
    .log .rowbtns{display:flex; gap:8px}
    .ghost{color:var(--muted); font-style:italic}
  </style>
</head>
<body>
  <div class="wrap">
    <!--  arriba de todo -->
    <div style="text-align: center; margin-bottom: 2px;">
      <img src="Dise√±o sin t√≠tulo.png" alt="Luthiplast Logo" style="max-width: 250px; height: auto; margin-top: -2px"> <!-- Aqu√≠ debes poner la ruta de tu logo -->
    </div>

    <div class="card">
      <header>
        <h1>Nueva Cotizaci√≥n</h1>
      </header>

      <!-- Cabecera -->
      <div class="form">
        <div class="field"><label>Cliente:</label><input id="att" placeholder="Nombre"></div>
        <div class="field"><label>Celular:</label><input id="tel1" placeholder="7052-8888"></div>
        <div class="field"><label>Ruc:</label><input id="company" placeholder="Ingrese RUC"></div>
        <div class="field"><label>Tel√©fono:</label><input id="tel2" placeholder="2222-2222"></div>
        <div class="field"><label>Email:</label><input id="email" placeholder="info@tuempresa.com"></div>
      </div>

      <!-- Acciones -->
      <div class="toolbar">
        <button class="btn icon primary" id="btnAdd"><span>Ôºã</span>Agregar productos</button>
        <button class="btn icon" id="btnPrint">üñ®Ô∏è Imprimir</button>
        <button class="btn icon" id="btnPdf">‚¨áÔ∏è Descargar PDF</button>
      </div>

      <!-- Tabla -->
      <div style="padding:0 22px 16px">
        <table id="tabla">
          <thead>
            <tr>
              <th style="width:120px">CODIGO</th>
              <th style="width:80px">CANT.</th>
              <th style="width:80px">m¬≤</th>
              <th>DESCRIPCION</th>
              <th style="width:160px" class="num">PRECIO UNIT.</th>
              <th style="width:160px" class="num">PRECIO TOTAL</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody id="body">
            <!-- Filas din√°micas -->
          </tbody>
          <tfoot>
            <tr class="subtotal">
              <td colspan="5" class="num"><strong>SUBTOTAL S/</strong></td>
              <td class="num" id="vSubtotal">0.00</td>
              <td></td>
            </tr>
            <tr class="igv">
              <td colspan="5" class="num"><strong>IGV 18% S/</strong></td>
              <td class="num" id="vIgv">0.00</td>
              <td></td>
            </tr>
            <tr class="total">
              <td colspan="5" class="num"><strong>TOTAL S/</strong></td>
              <td class="num" id="vTotal">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Guardado / Registro -->
      <div class="aside">
        <button class="btn primary" id="btnSave">Guardar cotizaci√≥n</button>
        <span class="ghost" id="savedHint" style="margin-left:10px"></span>

        <div class="log">
          <h3>Registro de cotizaciones</h3>
          <ul id="logList"></ul>
        </div>
      </div>
    </div>
  </div>

<script>
  // Inicializar Supabase
  const supabaseUrl = 'https://luthiplast-73154.supabase.co';
  const supabaseKey = 'sb_publica_XXXXX';  // Usa la Publishable Key aqu√≠
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  // Utilidades de formato
  const money = n => (isNaN(n)?0:n).toFixed(2);
  const num = v => parseFloat(String(v).replace(',', '.')) || 0;

  // Agregar fila
  function addRow(data={}) {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><input class="cell" placeholder="MG01" value="${data.codigo||''}"></td>
      <td><input class="cell center qty" type="number" min="0" step="1" placeholder="1" value="${data.cant||''}"></td>
      <td><input class="cell center m2" type="number" min="0" step="0.01" placeholder="0.00" value="${data.m2||''}"></td>
      <td><input class="cell" placeholder="Descripci√≥n del producto" value="${data.desc||''}"></td>
      <td class="num"><input class="cell right unit" type="number" min="0" step="0.01" placeholder="0.00" value="${data.unit||''}"></td>
      <td class="num total">0.00</td>
      <td class="actions"><button class="btn" title="Eliminar">üóëÔ∏è</button></td>
    `;

    // eventos
    const qty = tr.querySelector('.qty');
    const m2 = tr.querySelector('.m2');
    const unit = tr.querySelector('.unit');
    qty.addEventListener('input', recalcAll);
    m2.addEventListener('input', recalcAll);
    unit.addEventListener('input', recalcAll);
    tr.querySelector('button').addEventListener('click', () => { tr.remove(); recalcAll(); });

    document.getElementById('body').appendChild(tr);
    recalcRow(tr);
    recalcAll();
  }

  // Recalcula una fila
  function recalcRow(tr){
    const qty = num(tr.querySelector('.qty').value);
    const u = num(tr.querySelector('.unit').value);
    const m2 = num(tr.querySelector('.m2').value);
    
    // Condicional: si m¬≤ est√° vac√≠o, se calcula como precio unitario por cantidad
    const total = m2 ? (m2 * u * qty) : (u * qty);
    
    tr.querySelector('.total').textContent = money(total);
  }

  // Recalcula toda la tabla
  function recalcAll(){
    document.querySelectorAll('#body tr').forEach(recalcRow);
    let subtotal = 0;
    document.querySelectorAll('#body tr .total').forEach(td => subtotal += num(td.textContent));
    const igv = subtotal * 0.18;
    const total = subtotal + igv;
    document.getElementById('vSubtotal').textContent = money(subtotal);
    document.getElementById('vIgv').textContent = money(igv);
    document.getElementById('vTotal').textContent = money(total);
  }

  // Guardar cotizaci√≥n en Supabase
  async function saveQuoteToDatabase() {
    const rows = [...document.querySelectorAll('#body tr')].map(tr => ({
      codigo: tr.children[0].querySelector('input').value.trim(),
      cant: tr.children[1].querySelector('input').value.trim(),
      m2: tr.children[2].querySelector('input').value.trim(),
      desc: tr.children[3].querySelector('input').value.trim(),
      unit: tr.children[4].querySelector('input').value.trim(),
      total: tr.children[5].textContent.trim()
    }));
    const subtotal = document.getElementById('vSubtotal').textContent;
    const igv = document.getElementById('vIgv').textContent;
    const total = document.getElementById('vTotal').textContent;

    const meta = {
      cliente: document.getElementById('att').value.trim(),
      ruc: document.getElementById('company').value.trim(),
      tel1: document.getElementById('tel1').value.trim(),
      tel2: document.getElementById('tel2').value.trim(),
      email: document.getElementById('email').value.trim(),
    };

    const quote = {
      id: 'COT-' + Date.now(),
      fecha: new Date().toLocaleString(),
      meta, rows, subtotal, igv, total
    };

    // Insertar en Supabase
    const { data, error } = await supabase
      .from('cotizaciones') // Nombre de la tabla en Supabase
      .insert([quote]);

    if (error) {
      console.error("Error al guardar cotizaci√≥n:", error);
    } else {
      console.log("Cotizaci√≥n guardada con √©xito:", data);
      alert("Cotizaci√≥n guardada con √©xito");
    }
  }

  // Llamar a la funci√≥n cuando se guarda la cotizaci√≥n
  document.getElementById('btnSave').addEventListener('click', saveQuoteToDatabase);

  // Cargar cotizaciones guardadas al recargar la p√°gina
  window.onload = renderLog;
</script>
</body>
</html>
