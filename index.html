<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nueva Cotizaci√≥n</title>

  <!-- jsPDF + AutoTable (para PDF) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg: #0c1434; /* Fondo oscuro */
      --card: #ffffff; /* Fondo blanco para las tarjetas */
      --ink: #0c1434; /* Texto claro */
      --primary: #7e8a97; /* Color primario de texto */
      --primary-ink: #fff; /* Texto en color blanco */
      --line: #e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1000px; margin:28px auto; padding:0 16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.05)}
    header{display:flex; align-items:center; gap:12px; padding:20px 22px; border-bottom:1px solid var(--line)}
    header h1{margin:0; font-size:24px; color: var(--primary)}
    .form{display:grid; grid-template-columns:1fr 1fr; gap:14px 18px; padding:18px 22px}
    .field{display:flex; gap:10px; align-items:center}
    .field label{width:110px; color:var(--muted); font-size:14px}
    .field input{flex:1; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:15px}
    .toolbar{display:flex; justify-content:flex-end; gap:10px; padding:0 22px 16px}
    .btn{border:1px solid var(--line); background:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600}
    .btn.primary{background:var(--primary); color:var(--primary-ink); border:none}
    .btn.icon{display:inline-flex; align-items:center; gap:8px}
    .btn:active{transform:translateY(1px)}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{background:#f3f4f6; text-align:left; padding:12px; border-bottom:1px solid var(--line); color:#111827}
    tbody td{padding:10px 12px; border-bottom:1px solid var(--line); vertical-align:middle}
    tbody td.num{text-align:right; white-space:nowrap}
    tbody td.actions{width:40px; text-align:center}
    tfoot td{padding:8px 12px}
    tfoot tr.subtotal td,
    tfoot tr.igv td,
    tfoot tr.total td{border-top:1px solid var(--line)}
    tfoot tr.total td{font-weight:800; font-size:16px}
    input.cell{width:100%; border:1px solid var(--line); border-radius:6px; padding:8px 10px; font-size:14px}
    input.cell.center{text-align:center}
    input.cell.right{text-align:right}
    .aside{padding:16px 22px 22px; border-top:1px solid var(--line)}
    .log{margin-top:24px}
    .log h3{margin:0 0 10px 0; font-size:18px}
    .log ul{list-style:none; padding:0; margin:0; display:grid; gap:8px}
    .log li{display:flex; align-items:center; justify-content:space-between; background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px 12px}
    .log small{color:var(--muted)}
    .log .rowbtns{display:flex; gap:8px}
    .ghost{color:var(--muted); font-style:italic}

    /* Estilos para indicadores de estado */
    .sync-indicator {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .sync-indicator.syncing {
      background-color: #fbbf24;
      color: #92400e;
    }
    .sync-indicator.success {
      background-color: #10b981;
      color: #065f46;
    }
    .sync-indicator.error {
      background-color: #ef4444;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!--  arriba de todo -->
    <div style="text-align: center; margin-bottom: 2px;">
      <img src="Dise√±o sin t√≠tulo.png" alt="Luthiplast Logo" style="max-width: 250px; height: auto; margin-top: -2px"> <!-- Aqu√≠ debes poner la ruta de tu logo -->
    </div>

    <div class="card">
      <header>
        <h1>Nueva Cotizaci√≥n</h1>
      </header>

      <!-- Cabecera -->
      <div class="form">
        <div class="field"><label>Cliente:</label><input id="att" placeholder="Nombre"></div>
        <div class="field"><label>Celular:</label><input id="tel1" placeholder="7052-8888"></div>
        <div class="field"><label>Ruc:</label><input id="company" placeholder="Ingrese RUC"></div>
        <div class="field"><label>Tel√©fono:</label><input id="tel2" placeholder="2222-2222"></div>
        <div class="field"><label>Email:</label><input id="email" placeholder="info@tuempresa.com"></div>
      </div>

      <!-- Acciones -->
      <div class="toolbar">
        <button class="btn icon primary" id="btnAdd"><span>Ôºã</span>Agregar productos</button>
        <button class="btn icon" id="btnPrint">üñ®Ô∏è Imprimir</button>
        <button class="btn icon" id="btnPdf">‚¨áÔ∏è Descargar PDF</button>
      </div>

      <!-- Tabla -->
      <div style="padding:0 22px 16px">
        <table id="tabla">
          <thead>
            <tr>
              <th style="width:120px">CODIGO</th>
              <th style="width:80px">CANT.</th>
              <th style="width:80px">m¬≤</th>
              <th>DESCRIPCION</th>
              <th style="width:160px" class="num">PRECIO UNIT.</th>
              <th style="width:160px" class="num">PRECIO TOTAL</th>
              <th style="width:40px"></th>
            </tr>
          </thead>
          <tbody id="body">
            <!-- Filas din√°micas -->
          </tbody>
          <tfoot>
            <tr class="subtotal">
              <td colspan="5" class="num"><strong>SUBTOTAL S/</strong></td>
              <td class="num" id="vSubtotal">0.00</td>
              <td></td>
            </tr>
            <tr class="igv">
              <td colspan="5" class="num"><strong>IGV 18% S/</strong></td>
              <td class="num" id="vIgv">0.00</td>
              <td></td>
            </tr>
            <tr class="total">
              <td colspan="5" class="num"><strong>TOTAL S/</strong></td>
              <td class="num" id="vTotal">0.00</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Guardado / Registro -->
      <div class="aside">
        <button class="btn primary" id="btnSave">Guardar cotizaci√≥n</button>
        <span class="ghost" id="savedHint" style="margin-left:10px"></span>

        <div class="log">
          <h3>Registro de cotizaciones</h3>
          <ul id="logList"></ul>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========== CONFIGURACI√ìN GOOGLE SHEETS ==========
  // IMPORTANTE: Reemplaza esta URL con la de tu Google Apps Script
  const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbykMJjHSZDeNDf38kHPHIHGqUL7LCwLv0jhPtrgBS2-KEe5aOtNaaxAG6aqh0kH-Y9V/exec';
  
  // Variable para debugging
  let debugMode = true;
  
  function log(message, data = null) {
    if (debugMode) {
      console.log('üîç COTIZADOR:', message);
      if (data) console.log(data);
    }
  }
  
  // ========== UTILIDADES ==========
  const money = n => (isNaN(n)?0:n).toFixed(2);
  const num = v => parseFloat(String(v).replace(',', '.')) || 0;

  // ========== FUNCI√ìN PARA ENVIAR DATOS A GOOGLE SHEETS ==========
  async function sendToGoogleSheets(quote) {
    log('=== INICIANDO ENV√çO A GOOGLE SHEETS ===');
    log('Datos a enviar:', quote);
    log('URL configurada:', GOOGLE_SHEETS_URL);
    
    // Verificar URL configurada
    if (GOOGLE_SHEETS_URL.includes('TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI')) {
      log('‚ùå ERROR: URL de Google Apps Script NO est√° configurada');
      alert('‚ö†Ô∏è Error: Debes configurar la URL de Google Apps Script en el c√≥digo.\n\nBusca la l√≠nea:\nconst GOOGLE_SHEETS_URL = ...\n\ny reemplaza TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI con tu URL real.');
      return false;
    }
    
    try {
      // Crear URL con par√°metros
      const params = new URLSearchParams();
      params.append('data', JSON.stringify(quote));
      
      const fullUrl = GOOGLE_SHEETS_URL + '?' + params.toString();
      log('URL de petici√≥n:', fullUrl.substring(0, 150) + '...[TRUNCADA]');
      
      log('üì§ Enviando petici√≥n...');
      
      const response = await fetch(fullUrl, {
        method: 'GET',
        redirect: 'follow',
        headers: {
          'Accept': 'text/html,application/json,text/plain,*/*'
        }
      });
      
      log('üì• Respuesta recibida');
      log('Status:', response.status);
      log('Status Text:', response.statusText);
      log('Headers:', Object.fromEntries([...response.headers.entries()]));
      
      if (response.ok) {
        const result = await response.text();
        log('‚úÖ Respuesta exitosa:', result);
        
        // Intentar parsear como JSON
        try {
          const jsonResult = JSON.parse(result);
          log('üìã Respuesta JSON:', jsonResult);
          
          if (jsonResult.success === true) {
            log('üéâ √âXITO: Datos guardados en Google Sheets');
            return true;
          } else {
            log('‚ö†Ô∏è Respuesta indica fallo:', jsonResult);
            return false;
          }
        } catch (parseError) {
          log('üìù Respuesta no es JSON, pero request fue exitoso');
          // Si la respuesta contiene texto que indica √©xito
          if (result.includes('success') || result.includes('guardado')) {
            log('üéâ Parece que fue exitoso basado en el contenido');
            return true;
          }
          return true; // Asumir √©xito si no hay error HTTP
        }
      } else {
        log('‚ùå Error HTTP:', response.status, response.statusText);
        
        // Intentar leer el error
        try {
          const errorText = await response.text();
          log('üìÑ Contenido del error:', errorText);
        } catch (readError) {
          log('No se pudo leer el contenido del error');
        }
        
        return false;
      }
      
    } catch (error) {
      log('üí• EXCEPCI√ìN en fetch:', error.toString());
      log('Stack trace:', error.stack);
      
      // Mostrar error al usuario solo en modo debug
      if (debugMode) {
        alert('Error de conexi√≥n con Google Sheets:\n' + error.toString() + '\n\nRevisa la consola para m√°s detalles.');
      }
      
      return false;
    }
  }

  // ========== FUNCI√ìN PARA AGREGAR FILAS ==========
  function addRow(data={}) {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td><input class="cell" placeholder="MG01" value="${data.codigo||''}"></td>
      <td><input class="cell center qty" type="number" min="0" step="1" placeholder="1" value="${data.cant||''}"></td>
      <td><input class="cell center m2" type="number" min="0" step="0.01" placeholder="0.00" value="${data.m2||''}"></td>
      <td><input class="cell" placeholder="Descripci√≥n del producto" value="${data.desc||''}"></td>
      <td class="num"><input class="cell right unit" type="number" min="0" step="0.01" placeholder="0.00" value="${data.unit||''}"></td>
      <td class="num total">0.00</td>
      <td class="actions"><button class="btn" title="Eliminar">üóëÔ∏è</button></td>
    `;

    // eventos
    const qty = tr.querySelector('.qty');
    const m2 = tr.querySelector('.m2');
    const unit = tr.querySelector('.unit');
    qty.addEventListener('input', recalcAll);
    m2.addEventListener('input', recalcAll);
    unit.addEventListener('input', recalcAll);
    tr.querySelector('button').addEventListener('click', () => { tr.remove(); recalcAll(); });

    document.getElementById('body').appendChild(tr);
    recalcRow(tr);
    recalcAll();
  }

  // ========== REC√ÅLCULOS ==========
  function recalcRow(tr){
    const qty = num(tr.querySelector('.qty').value);
    const u = num(tr.querySelector('.unit').value);
    const m2 = num(tr.querySelector('.m2').value);
    
    // Condicional: si m¬≤ est√° vac√≠o, se calcula como precio unitario por cantidad
    const total = m2 ? (m2 * u * qty) : (u * qty);
    
    tr.querySelector('.total').textContent = money(total);
  }

  function recalcAll(){
    document.querySelectorAll('#body tr').forEach(recalcRow);
    let subtotal = 0;
    document.querySelectorAll('#body tr .total').forEach(td => subtotal += num(td.textContent));
    const igv = subtotal * 0.18;
    const total = subtotal + igv;
    document.getElementById('vSubtotal').textContent = money(subtotal);
    document.getElementById('vIgv').textContent = money(igv);
    document.getElementById('vTotal').textContent = money(total);
  }

  // ========== GUARDAR COTIZACI√ìN (MODIFICADA PARA GOOGLE SHEETS) ==========
  async function saveQuote(){
    // Validar que hay al menos un producto
    const rows = [...document.querySelectorAll('#body tr')];
    if (rows.length === 0) {
      alert('Debe agregar al menos un producto para guardar la cotizaci√≥n');
      return;
    }

    // Crear objeto de datos
    const rowsData = rows.map(tr => ({
      codigo: tr.children[0].querySelector('input').value.trim(),
      cant: tr.children[1].querySelector('input').value.trim(),
      m2: tr.children[2].querySelector('input').value.trim(),
      desc: tr.children[3].querySelector('input').value.trim(),
      unit: tr.children[4].querySelector('input').value.trim(),
      total: tr.children[5].textContent.trim()
    }));
    
    const subtotal = document.getElementById('vSubtotal').textContent;
    const igv = document.getElementById('vIgv').textContent;
    const total = document.getElementById('vTotal').textContent;

    const meta = {
      cliente: document.getElementById('att').value.trim(),
      ruc: document.getElementById('company').value.trim(),
      tel1: document.getElementById('tel1').value.trim(),
      tel2: document.getElementById('tel2').value.trim(),
      email: document.getElementById('email').value.trim(),
    };

    const quote = {
      id: 'COT-' + Date.now(),
      fecha: new Date().toLocaleString(),
      meta, 
      rows: rowsData, 
      subtotal, 
      igv, 
      total
    };

    // Guardar localmente (como antes)
    const list = JSON.parse(localStorage.getItem('quotes') || '[]');
    list.unshift(quote);
    localStorage.setItem('quotes', JSON.stringify(list));

    // Mostrar estado de guardado
    const savedHint = document.getElementById('savedHint');
    savedHint.innerHTML = `Guardando... <span class="sync-indicator syncing">‚è≥</span>`;
    
    try {
      // Enviar a Google Sheets
      const googleSheetsSuccess = await sendToGoogleSheets(quote);
      
      if (googleSheetsSuccess) {
        savedHint.innerHTML = `Guardado ‚úì Total S/ ${total} <span class="sync-indicator success">‚òÅÔ∏è Sincronizado</span>`;
      } else {
        savedHint.innerHTML = `Guardado ‚úì Total S/ ${total} <span class="sync-indicator error">‚ö†Ô∏è Solo local</span>`;
      }
    } catch (error) {
      console.error('Error en sincronizaci√≥n:', error);
      savedHint.innerHTML = `Guardado ‚úì Total S/ ${total} <span class="sync-indicator error">‚ö†Ô∏è Error sync</span>`;
    }
    
    renderLog();

    // Limpiar mensaje despu√©s de 5 segundos
    setTimeout(() => {
      savedHint.textContent = '';
    }, 5000);
  }

  // ========== RENDER DE REGISTRO ==========
  function renderLog(){
    const list = JSON.parse(localStorage.getItem('quotes') || '[]');
    const ul = document.getElementById('logList');
    ul.innerHTML = '';
    if(!list.length){
      ul.innerHTML = '<li class="ghost">A√∫n no hay cotizaciones guardadas.</li>';
      return;
    }
    list.forEach(q => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <strong>${q.id}</strong> ‚Äî S/ ${q.total}
          <div><small>${q.fecha}</small></div>
        </div>
        <div class="rowbtns">
          <button class="btn" title="Mostrar" onclick='showQuote("${q.id}")'>Mostrar</button>
          <button class="btn" title="Descargar PDF" onclick='downloadPDF("${q.id}")'>PDF</button>
          <button class="btn" title="Borrar" onclick='deleteQuote("${q.id}")'>Borrar</button>
        </div>`;
      ul.appendChild(li);
    });
  }

  // ========== FUNCIONES DE COTIZACI√ìN ==========
  function findQuote(id){
    const list = JSON.parse(localStorage.getItem('quotes') || '[]');
    return list.find(q => q.id === id);
  }

  function showQuote(id){
    const q = findQuote(id);
    if(!q) return;
    // Limpia y carga la cotizaci√≥n en la UI
    document.getElementById('att').value = q.meta.cliente || '';
    document.getElementById('company').value = q.meta.ruc || '';
    document.getElementById('tel1').value = q.meta.tel1 || '';
    document.getElementById('tel2').value = q.meta.tel2 || '';
    document.getElementById('email').value = q.meta.email || '';

    document.getElementById('body').innerHTML = '';
    q.rows.forEach(r => addRow(r));
    // Poner totales exactos guardados
    document.getElementById('vSubtotal').textContent = q.subtotal;
    document.getElementById('vIgv').textContent = q.igv;
    document.getElementById('vTotal').textContent = q.total;
  }

  function deleteQuote(id){
    if(!confirm('¬øEst√° seguro de que desea borrar esta cotizaci√≥n?')) return;
    const list = JSON.parse(localStorage.getItem('quotes') || '[]').filter(q => q.id !== id);
    localStorage.setItem('quotes', JSON.stringify(list));
    renderLog();
  }

  // ========== GENERACI√ìN DE PDF MEJORADA CON FUENTE OPTIMIZADA ==========
  async function downloadPDF(id=null){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt', format:'a4'});

    const q = id ? findQuote(id) : null;

    const meta = q ? q.meta : {
      cliente: document.getElementById('att').value.trim(),
      ruc: document.getElementById('company').value.trim(),
      tel1: document.getElementById('tel1').value.trim(),
      tel2: document.getElementById('tel2').value.trim(),
      email: document.getElementById('email').value.trim(),
    };

    // Colores corporativos
    const azulOscuro = [12, 20, 52];
    const azulClaro = [126, 138, 151];
    const grisClaro = [240, 240, 240];

    // ENCABEZADO CORPORATIVO
    doc.setFillColor(...azulOscuro);
    doc.rect(0, 0, 595, 80, 'F');

    // Logo y datos de la empresa (lado izquierdo)
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('IMPORTACIONES LUTHIPLAST HRL', 40, 30);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Magdalena del Mar - Jr. Castilla 456', 40, 45);
    doc.text('Tel√©fono: 992 753 063 | E-mail: miguel@luthiplast.com', 40, 58);
    doc.text('www.luthiplast.com', 40, 71);

    // T√çTULO COTIZACI√ìN
    doc.setFillColor(...grisClaro);
    doc.rect(0, 80, 595, 35, 'F');
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('COTIZACI√ìN', 40, 102);

    // Informaci√≥n de fechas (lado derecho del t√≠tulo)
    const hoy = new Date();
    const fechaHoy = hoy.toLocaleDateString('es-PE');
    const fechaVencimiento = new Date(hoy.getTime() + (30 * 24 * 60 * 60 * 1000)).toLocaleDateString('es-PE');

    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text(`FECHA: ${fechaHoy}`, 440, 95);
    doc.text(`V√ÅLIDO HASTA: ${fechaVencimiento}`, 440, 108);

    // INFORMACI√ìN DEL CLIENTE
    doc.setFillColor(...azulClaro);
    doc.rect(40, 130, 515, 60, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('DATOS DEL CLIENTE:', 45, 150);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.text(`Cliente: ${meta.cliente || 'No especificado'}`, 45, 165);
    doc.text(`RUC: ${meta.ruc || 'No especificado'}`, 45, 178);
    doc.text(`Tel√©fonos: ${meta.tel1 || ''} ${meta.tel2 || ''}`.trim(), 300, 165);
    doc.text(`Email: ${meta.email || 'No especificado'}`, 300, 178);

    // TABLA DE PRODUCTOS
    const rows = (q ? q.rows : [...document.querySelectorAll('#body tr')].map(tr => ({
      codigo: tr.children[0].querySelector('input').value,
      cant: tr.children[1].querySelector('input').value,
      m2: tr.children[2].querySelector('input').value,
      desc: tr.children[3].querySelector('input').value,
      unit: tr.children[4].querySelector('input').value,
      total: tr.children[5].textContent
    })));

    // Preparar datos de la tabla
    const body = rows.map(r => {
      const cantidad = r.cant || '0';
      const m2Value = r.m2 || '';
      const precioUnit = `S/ ${money(num(r.unit))}`;
      const precioTotal = `S/ ${r.total || '0.00'}`;
      
      return [
        r.codigo || '', 
        cantidad,
        m2Value,
        r.desc || '', 
        precioUnit,
        precioTotal
      ];
    });

    // Encabezados de la tabla
    const tableHeaders = [['C√ìDIGO', 'CANT.', 'm¬≤', 'DESCRIPCI√ìN', 'PRECIO UNIT.', 'TOTAL']];

    doc.autoTable({
      startY: 210,
      head: tableHeaders,
      body: body,
      styles: { 
        fontSize: 9, 
        cellPadding: 6,
        lineWidth: 0.5,
        lineColor: [200, 200, 200],
        textColor: [0, 0, 0]
      },
      headStyles: { 
        fillColor: [...azulClaro], 
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        halign: 'center',
        fontSize: 9
      },
      columnStyles: {
        0: { halign: 'center', cellWidth: 70 },  // C√ìDIGO
        1: { halign: 'center', cellWidth: 50 },  // CANT.
        2: { halign: 'center', cellWidth: 45 },  // m¬≤
        3: { halign: 'left', cellWidth: 200 },   // DESCRIPCI√ìN
        4: { halign: 'right', cellWidth: 85 },   // PRECIO UNIT.
        5: { halign: 'right', cellWidth: 85 }    // TOTAL
      },
      alternateRowStyles: { fillColor: [250, 250, 250] },
      margin: { left: 40, right: 40 },
      tableWidth: 'wrap'
    });

    // TOTALES (parte inferior derecha) - FUENTES OPTIMIZADAS
    const tableEndY = doc.lastAutoTable.finalY + 15;
    const subtotal = q ? q.subtotal : document.getElementById('vSubtotal').textContent;
    const igv = q ? q.igv : document.getElementById('vIgv').textContent;
    const total = q ? q.total : document.getElementById('vTotal').textContent;

    // Fondo para totales
    doc.setFillColor(...grisClaro);
    doc.rect(350, tableEndY, 205, 75, 'F');
    doc.setDrawColor(200, 200, 200);
    doc.rect(350, tableEndY, 205, 75, 'S');

    // L√≠neas divisorias internas
    doc.line(350, tableEndY + 25, 555, tableEndY + 25);
    doc.line(350, tableEndY + 50, 555, tableEndY + 50);
    doc.line(480, tableEndY, 480, tableEndY + 75);

    doc.setTextColor(0, 0, 0);
    
    // **ETIQUETAS CON FUENTE REDUCIDA**
    doc.setFontSize(9); // Reducido de 11 a 9
    doc.setFont('helvetica', 'normal');
    doc.text('SUBTOTAL:', 415, tableEndY + 17, { align: 'center' });
    doc.text('IGV (18%):', 415, tableEndY + 42, { align: 'center' });
    doc.setFont('helvetica', 'bold');
    doc.text('TOTAL:', 415, tableEndY + 67, { align: 'center' });

    // **VALORES CON FUENTE REDUCIDA**
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8); // Reducido de 11 a 8 para valores normales
    doc.text(`S/ ${subtotal}`, 517, tableEndY + 17, { align: 'center' });
    doc.text(`S/ ${igv}`, 517, tableEndY + 42, { align: 'center' });
    
    // Total con fuente ligeramente m√°s grande pero a√∫n compacta
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(9); // Reducido de 12 a 9 para el total
    doc.text(`S/ ${total}`, 517, tableEndY + 67, { align: 'center' });

    // T√âRMINOS Y CONDICIONES
    const termsY = tableEndY + 120;
    
    // Verificar que no se salga de la p√°gina
    if (termsY > 650) {
      doc.addPage();
      const newTermsY = 50;
      addTermsAndConditions(doc, newTermsY);
    } else {
      addTermsAndConditions(doc, termsY);
    }

    // Funci√≥n para agregar t√©rminos y condiciones
    function addTermsAndConditions(doc, startY) {
      doc.setFillColor(255, 255, 255);
      doc.rect(40, startY, 515, 150, 'F');
      doc.setDrawColor(200, 200, 200);
      doc.rect(40, startY, 515, 150, 'S');

      doc.setTextColor(0, 0, 0);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('T√âRMINOS Y CONDICIONES', 50, startY + 20);

      doc.setFontSize(9);
      doc.setFont('helvetica', 'normal');
      const terminos = [
        ' 40% de adelanto.',
        ' 60% a la entrega.',
        ' Abonar en la Cta. Cte. No. 191-2650527-0-98  CCI: 00219100265052709858 Banco de la Naci√≥n cuenta en Nuevos Soles',
        ' Titular: Miguel Angel Zegarra Ayala',
        '',
        ' Si usted tiene alguna pregunta sobre esta cotizaci√≥n, por favor p√≥ngase en contacto con nosotros.',
        ' IMPORTACIONES LUTHIPLAST HRL | Tel√©fono: 992 753 063 | E-mail: miguel@luthiplast.com',
        '',
        '                                    ¬°Gracias por hacer negocios con nosotros!'
      ];

      let lineY = startY + 40;
      terminos.forEach(linea => {
        if (linea.trim() === '') {
          lineY += 8;
        } else {
          doc.text(linea, 55, lineY);
          lineY += 12;
        }
      });
    }

    doc.save((q?.id || 'cotizacion-' + Date.now()) + '.pdf');
  }

  // ========== FUNCI√ìN DE IMPRESI√ìN ==========
  function printPage(){ 
    window.print(); 
  }

  // ========== EVENTOS DE LA UI ==========
  document.getElementById('btnAdd').addEventListener('click', () => addRow());
  document.getElementById('btnPdf').addEventListener('click', () => downloadPDF());
  document.getElementById('btnPrint').addEventListener('click', printPage);
  document.getElementById('btnSave').addEventListener('click', saveQuote);

  // ========== INICIALIZACI√ìN ==========
  window.onload = function() {
    renderLog();
    
    // Verificar configuraci√≥n de Google Sheets
    if (GOOGLE_SHEETS_URL.includes('TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI')) {
      log('‚ö†Ô∏è ADVERTENCIA: URL de Google Apps Script no configurada');
      
      // Mostrar aviso visual
      const header = document.querySelector('header h1');
      if (header) {
        header.innerHTML = 'Nueva Cotizaci√≥n <span style="color: orange; font-size: 12px;">(‚ö†Ô∏è Google Sheets no configurado)</span>';
      }
    } else {
      log('‚úÖ URL de Google Apps Script configurada');
      
      // Probar conectividad
      testGoogleSheetsConnection();
    }
  };
  
  // Funci√≥n para probar la conexi√≥n con Google Sheets
  async function testGoogleSheetsConnection() {
    try {
      log('üîó Probando conexi√≥n con Google Sheets...');
      
      const response = await fetch(GOOGLE_SHEETS_URL, {
        method: 'GET',
        redirect: 'follow'
      });
      
      if (response.ok) {
        const result = await response.text();
        log('‚úÖ Conexi√≥n exitosa con Google Sheets');
        log('Respuesta del servidor:', result);
      } else {
        log('‚ö†Ô∏è Problema de conexi√≥n:', response.status);
      }
    } catch (error) {
      log('‚ùå Error de conexi√≥n:', error.toString());
    }
  }
</script>
</body>
</html>
